# RESTORE POINT

## Meta / Review Prerequisites
- [x] Re-read the active codebase (server, client, shared, legacy CoffeeScript stubs) plus every Markdown file changed in the last 31 days and `README_MODERNIZATION.md` before starting any new work; flag any doc/code drift as bugs.
- [x] Capture deltas from the re-read in this file and in `docs/HANDOFF.md`/`docs/RESTART.md` if startup or workflow guidance changed.

### Doc drift (latest re-read)
- (2026-02-02 23:35 local re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART. `npm run test:health` rerun passed (server/inline comments/uploads). Branch/date guardrails unchanged.
- (2026-02-02 23:30 local re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART. Perf harness rerun with 1000 blips passed budgets; metrics in `snapshots/perf/metrics-1770070825186-*.json` and renders in `snapshots/perf/render-1770070825186-*.png`. Branch/date guardrails unchanged.
- (2026-02-02 23:20 local re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART. Follow-the-Green smokes rerun with snapshots `snapshots/follow-the-green/1770070342398-*` (desktop) and `snapshots/follow-the-green/1770070373492-*` (mobile). Branch/date guardrails unchanged.
- (2026-02-02 23:10 local re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART. Updated BlipMenu Vitest coverage for read-only Collapse/Expand; toolbar-inline Playwright rerun passes with snapshots `snapshots/toolbar-inline/1770070087999-*-final.png`. Branch/date guardrails unchanged.
- (2026-02-02 20:20 local re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART. Read-only blip toolbar now includes Collapse/Expand buttons. Playwright `test:toolbar-inline` rerun passes with snapshots `snapshots/toolbar-inline/1770069215769-*-final.png`; BLB snapshot harness rerun passes with snapshots `snapshots/blb/1770069305557-*` (older set pruned). Branch/date guardrails unchanged.
- (2026-02-02 20:05 local re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART. BLB snapshot harness now asserts inline marker navigation to subblip view (URL change + `.subblip-view`), and the latest BLB snapshot set is `snapshots/blb/1770066696549-*` (older sets pruned). Branch/date guardrails unchanged.
- (2026-02-02 19:35 local re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART. Toolbar-inline smoke now expands via `.blip-collapsed-row` and forces editor click; Playwright rerun passes with snapshots `snapshots/toolbar-inline/1770057761024-*-final.png`. Branch/date guardrails unchanged.
- (2026-02-02 19:20 local re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART. Topic meta-blip now uses a single scrollable body so the topic title is the first line of the same pane as child blips; BLB docs updated to reflect single-container topic hierarchy. Playwright smokes re-run: `npm run test:toolbar-inline` pass with snapshots `snapshots/toolbar-inline/1770056160355-*`; `npm run test:follow-green` pass for desktop/mobile with snapshots `snapshots/follow-the-green/1770056216268-*` and `snapshots/follow-the-green/1770056239785-*`. Branch/date guardrails unchanged.
- (2026-02-02 16:40 local re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART. BLB inline `[+]` markers now navigate into subblip documents (no inline expansion); Ctrl+Enter inserts the marker and navigates into the new subblip for both topic and blip editors. Removed inline-expanded blip block from topic view. Playwright smokes re-run: `npm run test:toolbar-inline` pass with snapshots `snapshots/toolbar-inline/1770050150043-*`; `npm run test:follow-green` pass for desktop/mobile with snapshots `snapshots/follow-the-green/1770050219697-*` and `snapshots/follow-the-green-mobile/1770050254871-*`. Branch/date guardrails unchanged.
- (2026-02-02 16:08 local re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART. Added topic follow endpoints + list enrichment (author/snippet/follow state) with tests in `src/tests/routes.topics.follow.test.ts`. Playwright smokes now wait for `.rizzoma-layout` instead of a legacy Logout button; CORS allowlist defaults include `127.0.0.1:*` for local auth. Latest smokes: `npm run test:toolbar-inline` pass (read toolbar not found; snapshots `snapshots/toolbar-inline/1770044690847-*`), `npm run test:follow-green` pass for desktop/mobile with snapshots `snapshots/follow-the-green/1770044752598-*` and `snapshots/follow-the-green-mobile/1770044781987-*`. Branch/date guardrails unchanged.
- (2026-02-02 15:34 local re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART. Perf harness now uses `perfRender=lite`, skips touchTopic/history in perf mode, and benchmarks use per-stage duration. Latest 1000-blip run passed budgets: stage duration ~1.5s landing / ~0.5s expanded, memory 23MB, labels 1000/1000; metrics in `snapshots/perf/metrics-1770042725851-*.json`. Branch/date guardrails unchanged.
- (2026-02-02 15:13 local re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART. Perf mode detection now treats `perf=full` as perf for unread/sidebar skips. Latest 1000-blip run: TTF ~65–67s, memory 117MB, labels 1000/1000 with windowed ~5.9s landing and ~66s expanded; metrics in `snapshots/perf/metrics-1770041471455-*.json`. Branch/date guardrails unchanged.
- (2026-02-02 15:02 local re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART. Perf harness now logs windowed (first 200) render metrics and uses `x-rizzoma-perf=1` to skip blip history writes during perf seeding. Latest 1000-blip run: TTF ~66–69s, memory 125MB, labels 1000/1000 with windowed ~6.7s landing and ~69s expanded; metrics in `snapshots/perf/metrics-1770040727000-*.json`. Branch/date guardrails unchanged.
- (2026-02-02 05:52 local re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART. Perf mode now raises `/api/blips` limit via `perfLimit` (harness passes `perfLimit=1001`). Perf harness rerun (1000 blips) still failed budgets: TTF ~112–116s, memory 117MB, 1000/1000 labels; metrics in `snapshots/perf/metrics-1770006531946-*.json`. CouchDB logged `UND_ERR_HEADERS_TIMEOUT` during blip history writes under load. Branch/date guardrails unchanged.
- (2026-02-02 05:10 local re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART. Perf harness updated to wait for `.blip-collapsed-row` and run with 1000 blips (TTF ~93s, 500/1000 labels rendered; metrics in `snapshots/perf/metrics-1770005659623-*.json`). Branch/date guardrails remain intact; drift warnings unchanged.
- (2026-02-02 05:00 local re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART. BLB snapshot harness run (`node test-blb-snapshots.mjs`) refreshed `snapshots/blb/1770004650980-*`; harness now clicks the inline marker directly, and inline marker click handling uses event delegation + capture to stay responsive in view mode. Expanding a collapsed blip still marks it active so the toolbar shows immediately. Branch/date guardrails remain intact; drift warnings unchanged.
- (2025-12-09 21:XX CET re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART plus worklog-251208. Landing view must match `rizzoma-main.png`: label-only root blips, no children/body/editor until explicit expand (“+”). Perf harness landing metric should measure this collapsed state; expansions should be measured separately. Latest runs: `npm run lint:branch-context` green; Playwright smokes green (toolbar-inline/follow-green desktop+mobile) with FEAT_ALL=1; `npm run test:health` and targeted `client.getUserMediaAdapter.test.ts` pass. Perf harness: 200-blip PASS; 1k-blip still fails budgets (see perf section). Docs still contain historical demo/start-all/phase language; `docs/LINKS_REPARENT.md` remains missing.
- (2025-12-06 20:46 CET re-read) Added the missing Codex restart snippet into `docs/RESTART.md`, wired CI `health-checks` job (`npm run test:health`) and noted it in docs/HANDOFF; drift warnings unchanged (demo/start-all/phase timelines still historical, `docs/LINKS_REPARENT.md` still missing, perf/getUserMedia/backups backlog still active).
- (2025-12-06 20:43 CET re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART plus Markdown changed in the last 10 days (docs/EDITOR*.md); no new drift beyond existing warnings (demo/start-all/phase timelines still historical, `docs/LINKS_REPARENT.md` still missing, perf/getUserMedia/health/backups backlog still active).
- (2025-12-06 20:37 CET re-read) Re-read RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART plus all Markdown changed in the last 31 days; no new drift beyond existing warnings (demo/start-all/phase timelines still historical, `docs/LINKS_REPARENT.md` still missing, perf/getUserMedia/health/backups backlog still active).
- (2025-12-06 20:34 CET re-read) Re-read AGENTS.md/docs/RESTART.md and refreshed the Codex exec blocks + checkpoint timestamp; drift warnings remain unchanged (demo/start-all/phase language still historical, `docs/LINKS_REPARENT.md` still missing, perf/getUserMedia/health/backups backlog still active).
- (2025-12-06 20:30 CET re-read) Re-ran the checkpoint across RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART plus the Markdown touched in the last 31 days; no new drift beyond the standing warnings (demo/start-all/phase language still historical, `docs/LINKS_REPARENT.md` still missing, perf/getUserMedia/health/backups backlog still active).
- (2025-12-06 20:13 CET re-read) Rechecked RESTORE_POINT/README_MODERNIZATION/docs/HANDOFF/docs/RESTART plus all Markdown touched in the last 31 days; no new drift beyond existing warnings (demo/start-all/phase timelines still historical, `docs/LINKS_REPARENT.md` still missing, perf/getUserMedia/health/backups backlog still outstanding). Branch/date guardrails remain intact.
- (2025-12-06 20:04 CET re-read) Re-ran branch-context lint (now passes) and re-read all Markdown touched in the last 31 days plus RESTORE/README_MODERNIZATION/HANDOFF/RESTART; no new drift beyond the existing warnings. `README.md` remains historical/removed, demo/start-all overstatements persist across onboarding docs, and `docs/LINKS_REPARENT.md` is still missing—restore/replace before referencing it.
- (2025-12-06 19:38 CET re-read) Rechecked all Markdown changed in the last 31 days; no new drift beyond existing warnings. `README.md` remains a historical modernization/phase1 snapshot (deleted in this working tree), `QUICKSTART.md`/`TESTING_GUIDE.md`/`CLAUDE.md` still advertise demo/start-all/“all green” flows, and `docs/LINKS_REPARENT.md` is still missing—restore/replace before referencing it. Timestamps in the handoff/restart guides now reflect this re-read.
- (2025-12-06 19:20 CET re-read) README/README_MODERNIZATION/README_MODERNIZATION.md and the other modernization strategy docs still describe "phase" timelines (e.g., `modernization/phase1`) that no longer reflect the active branch; treat that phase language as historical context only. `RIZZOMA_FEATURES_STATUS.md` is the branch-specific truth for feature coverage on `feature/rizzoma-core-features`, and it already aligns with the current backlog (perf/getUserMedia/health/backups still pending).
- Added branch-context guardrails to `AGENTS.md`, `docs/HANDOFF.md`, and `docs/RESTART.md` so status summaries must include branch+date and the historical master snapshot is clearly labeled; `npm run lint:branch-context` now enforces the `docs/HANDOFF.md` heading matches the active branch.
- (2025-12-06) `docs/HANDOFF.md` "Current State" now refreshed for `feature/rizzoma-core-features` (dated 2025-12-06) with presence/unread/upload/perf/health highlights.
- `RIZZOMA_FEATURES_STATUS.md` and `TESTING_STATUS.md` were refreshed to call out perf/backup/health gaps and the latest recorded runs (2026-03-12) but still rely on rerunning tests before trusting results.
- (2025-12-06 re-read) `README.md` (still anchored to `modernization/phase1` and claiming production-ready parity), `README_MODERNIZATION.md`, `QUICKSTART.md`, `CLAUDE.md`, `MANUAL_TEST_CHECKLIST.md`, and `AGENTS.md` still tout demo-mode/start-all automation, “all core features green,” and auto-merge/auto-commit flows that ignore the perf/unread/upload/backups backlog and removal of demo fallbacks; treat them as historical until rewritten for `feature/rizzoma-core-features` with real auth only plus perf/health budgets.
- `docs/HANDOFF.md` and `docs/RESTART.md` are now updated (2025-12-06) with current priorities/backlog; keep them synced when CI/perf/adapter/backup work lands.
- `docs/LINKS_REPARENT.md` was referenced in recent history but is no longer in `docs/`; restore or update references if link management guidance is still needed.
- `MODERNIZATION_STRATEGY.md`, `PARALLEL_DEVELOPMENT_PLAN.md`, `MANUAL_TEST_CHECKLIST.md`, and `TESTING_GUIDE.md` still promise multi-week completion timelines and “everything is green” assertions that contradict the current backlog; treat them as historical context until we rewrite them with the perf/resilience + CI gating reality (no demo shortcuts, perf harness budgets pending, browser smokes required).
- (2025-12-06 re-read) `README_MODERNIZATION.md` still frames modernization as largely complete/phase-1 ready and omits the current perf/health/getUserMedia/backup backlog; treat it as historical until rewritten for this branch.
- (2025-12-06 re-read) `docs/EDITOR_REALTIME.md` "Next steps" still lists presence/recovery/search as future even though they shipped; needs an updated roadmap and alignment with the perf/resilience backlog.
- (2025-12-06 re-read) `docs/HANDOFF.md`/`docs/RESTART.md` remain dated 2025-12-06 with a historical "Current State" snapshot; keep using the branch/date guardrails and refresh the snapshot after the next perf/adapter/health/backups updates. `RIZZOMA_FEATURES_STATUS.md` and `TESTING_STATUS.md` still reflect historical runs (Dec 2025) and require reruns before relying on them.
- (2025-12-06 re-read, 19:14 CET) Sweeped all Markdown touched in the last 31 days; no new drift beyond existing warnings. `QUICKSTART.md`, `TESTING_GUIDE.md`, and `CLAUDE.md` still push `npm run start:all`/auto-commit/demo-mode narratives that do not match the current perf/health/backups backlog or real-auth requirement—keep treating them as historical checklists until rewritten.

## Outstanding TODO Backlog (Excruciating Detail)

### Realtime, presence, recovery, and search
- [x] Presence identity polish: surface `editor:presence` payload users in both WaveView and editor panes (avatars/initials + tooltip) with empty/error/loading states; add Vitest coverage for join/leave debounce and stale presence expiry in `src/server/lib/socket.ts` + client renderers.
  - (2026-02-XX) Socket presence tracking now runs through `EditorPresenceManager` (de-bounced emits + TTL cleanup) with heartbeat pings from the client; `server.editorPresence.test.ts` covers join/leave coalescing, TTL expiry, and heartbeat refresh. `WaveView` + `Editor` now mount a shared `PresenceIndicator` that renders avatars/count along with loading/empty/error states, with deterministic UI coverage in `client.PresenceIndicator.test.tsx`.
- [x] Recovery UI: replace the single rebuild button with a progress/log surface (queued/running/complete, errors list, snapshots applied count) that polls `/api/editor/:waveId/rebuild?blipId=`; add failure toasts + retry; cover with route tests (mock CouchDB failures) and UI tests exercising long-running rebuilds.
  - (2026-03-05) `/api/editor/:waveId/rebuild` now exposes GET status plus an async queue with log history, queued/running/error states, and automatic cleanup. `RebuildPanel` in `WaveView` renders the status/log surface, auto-polls active jobs, shows applied counts, and surfaces retry toasts. Added Vitest coverage in `client.RebuildPanel.test.tsx` and expanded `routes.editor.rebuild.test.ts` to cover success/error flows.
- [x] Search materialization polish: finalize Mango/view indexes for `/api/editor/search` (blip-scoped + wave-level) and add result relevance ordering; extend `EditorSearch.tsx` to show snippet context and a “jump to blip” action; add endpoint tests for pagination/bookmark + malformed queries.
  - (2026-03-05) `/api/editor/search` now enforces Mango index creation, adds bookmark-based pagination, sorts by `updatedAt desc`, emits contextual snippets, and guards long queries. `EditorSearch` renders snippets, jump buttons, and load-more pagination via the new `nextBookmark`. Added new Vitest suites (`routes.editor.search.test.ts`, `client.EditorSearch.test.tsx`) covering pagination, malformed queries, snippets, and jump actions.
- [x] Follow-the-Green validation: ensure unread navigation works at wave level (next/prev/unread count) with realtime edits; add Playwright/Vitest coverage that edits remote content and verifies navigation highlights update without losing selection.
  - (2026-03-05) Added `test-follow-green-smoke.mjs` (`npm run test:follow-green`) which registers/logs two users, creates a fresh wave, triggers a remote blip via the API, and validates that the observer’s Follow-the-Green CTA jumps to and clears the unread blip.
  - (2026-03-12) `client.RightToolsPanel.followGreen.test.tsx` and `client.useWaveUnread.test.tsx` now assert degraded-path handling (CTA status + toast + refresh) when mark-read calls fail, and `test-follow-green-smoke.mjs` seeds multiple unread blips, forces a mark-read failure, verifies inline toasts/statuses, and replays the flow in a mobile viewport before clearing all unread items. The new `browser-smokes` CI job runs both Playwright suites, captures snapshots, and uploads artifacts for triage whenever they fail.
  - (2025-12-09) Socket host fix + FEAT_ALL gating restored unread event delivery; Playwright follow-green now runs desktop + mobile in one invocation and passes without the API fallback (snapshots under `snapshots/follow-the-green/*-1765298128125*.png` and `*-1765296401439*.png`).
- [ ] Perf/resilience sweeps: soak-test large waves/blips, inline comments, playback, and realtime updates for latency/memory; add metrics/logging hooks and document thresholds/known limits.
  - (2026-03-12) Added `perf-harness.mjs` (`npm run perf:harness`) to seed a 5k-blip wave via the API, drive Playwright against the freshly-seeded wave, record time-to-first-render metrics, and persist screenshots/metrics under `snapshots/perf/` for future regression tracking. We still need to schedule regular runs and document thresholds/alerting.
  - (2025-12-09) Perf harness runs: 200-blip run PASS (TTF 2173.8ms, FCP 260ms, ~38MB, rendered 101/200) at `snapshots/perf/metrics-1765300707079.json`; 1000-blip runs FAIL budgets — full render runs TTF 9877.7ms/17810.9ms with ~159–179MB and 1001/1000 rendered (`metrics-1765311846360.json`, `metrics-1765313105103.json`), and landing/label-only (collapsed) view reports TTF 6271.8ms, FCP 496ms, 14MB with 1/1000 rendered because the harness stops at the first blip shell (`metrics-1765316516984.json`). `scripts/perf-budget.mjs` added to assert budgets; keep landing metric on label-only state and add explicit expand metrics for branches while reducing TTF for large waves.

### Read/unread state and navigation
- [x] Implement real read/unread tracking for blips/topics (replace `isRead: true` in `RizzomaTopicDetail.tsx`): persist per-user state in CouchDB/Redis, expose API endpoints, hydrate in lists/detail, and render badges + keyboard navigation; add optimistic updates + rollback on failure.
- [x] Wire unread state to realtime updates so edits mark unread for other users and resolve when opened/read; add regression tests for concurrent sessions.
  - (2026-02-XX) Unread endpoints now compare `updatedAt` to per-user `readAt`, update existing read docs instead of no-op, and emit `blip:created/updated/deleted/read` socket events. WaveView adds unread badges, realtime refresh, optimistic mark-read with rollback toast, first/prev/next/last helpers, and an inline unread counter, while `RizzomaTopicDetail` hydrates `isRead` for the root and replies and surfaces unread badges in `RizzomaTopicsList`. Added coverage in `src/tests/routes.waves.unread.test.ts` and UI smoke in `client.followGreenNavigation.test.tsx`; `WaveView` now guards the optimistic flow against failures by re-syncing unread lists.
  - (2026-03-XX) Added `computeWaveUnreadCounts` to share CouchDB persistence logic across `/api/waves/unread_counts` and `/api/topics`, introduced `useWaveUnread` to hydrate the Rizzoma layout, wired optimistic `markBlipRead` flows into `RizzomaBlip`/`RightToolsPanel`, and surfaced unread badges in the topics list so the modern UI reflects server state with rollback on failures.

### Auth, permissions, and error handling
- [x] Replace `demo-user` fallbacks and enforce permissions for blip/topic create/update/delete; implement the TODO permission check in `src/server/routes/blips.ts` with integration tests (authorized/unauthorized).
  - (2026-02-XX) All blip/topic write endpoints now use `requireAuth`, log denied actions, and honor real ownership checks; `RizzomaLanding` routes sign-in through the real `AuthPanel` instead of demo shortcuts so unauthenticated sessions can no longer mutate data. Added targeted coverage in `src/tests/routes.blips.permissions.test.ts` for unauthenticated/forbidden/authorized updates plus topic delete denials.
- [x] Add user-facing error toasts for failed blip edits/replies in `RizzomaBlip.tsx`.
- [x] Ensure inline comments/playback/delete obey permissions and show degraded-state banners when APIs fail.
  - [x] (2025-12-24) Inline Comments nav/popover now surfaces a read-only banner whenever `canComment` is false, complementing the existing API failure messaging so degraded states are obvious without user interaction; added Vitest coverage in `client.inlineCommentsPopover.test.tsx`.
  - [x] (2026-01-05) Inline comments now show a persistent degraded-state banner with a Retry control whenever the fetch fails, including unauthorized messaging and Vitest coverage in `client.inlineCommentsPopover.test.tsx`; retry clears the failure banner once comments load successfully so API outages are explicit.
  - [x] (2025-12-04) BlipMenu always renders the inline comment toggle, shows a read-only banner when commenting is disabled, keeps paste-as-reply visible (but disabled with explanatory tooltip), and adds a loading indicator in `InlineComments.tsx` so degraded states are surfaced directly from the toolbar/editor surfaces.
  - [x] (2025-12-04) InlineComments now reports load failures back to `RizzomaBlip`, and BlipMenu mirrors those degraded/error banners directly in the inline toolbar so outages are obvious without opening the popover; Vitest covers the new status callback + toolbar banner rendering.
- [ ] Align inline comments, playback, uploads, and delete actions with authenticated identity metadata; add logging for denied actions.

### Uploads, media, and gadget nodes
- [x] Finish real upload pipeline: `src/server/routes/uploads.ts` now validates MIME signatures, blocks executables, optionally streams through ClamAV via `CLAMAV_HOST`/`CLAMAV_PORT`, and supports both filesystem and S3/MinIO storage (`UPLOADS_STORAGE`, `UPLOADS_S3_*`, `UPLOADS_S3_PUBLIC_URL`). The client upload helper gained a cancelable `createUploadTask`, `RizzomaBlip` surfaces inline progress + preview + retry/dismiss controls, and the new GitHub smoke job captures toolbar/upload screenshots for regressions.
- [x] Replace placeholder gadget buttons with durable TipTap nodes (chart/poll/attachment/image) that load from stored payloads; add serialization/parse tests and UI coverage for insert/edit/delete.
  - (2026-03-12) Added `src/tests/client.editor.GadgetNodes.test.ts` to assert chart/poll gadgets parse/render legacy attributes and expose working commands through TipTap, keeping the restored gadget buttons honest.
- [x] Modernize `getUserMedia` adapter (`src/static/js/getUserMediaAdapter.js`, `src/static/tests/adapter.js`) to new APIs with fallback detection and tests.
  - (2025-12-06) Adapter now normalizes constraints, detects display media, exposes permission status helpers and device enumeration, and is covered by `src/tests/client.getUserMediaAdapter.test.ts` (Vitest targeted run passed).

### Legacy migration and modernization
- [ ] Migrate remaining CoffeeScript entrypoints (`src/share/*.coffee`, `src/*_index.coffee`, `app.js`, legacy client bundles) to TypeScript/ESM; remove CoffeeScript runtime wrappers and update imports.
- [ ] Replace deprecated libs per `README_MODERNIZATION.md` (cradle→direct HTTP/nano, connect-redis update, sockjs→Socket.IO already partly done, mailparser/node-xmpp upgrades); add type coverage for upgraded middleware.
- [ ] Decide disposition for `original-rizzoma` and legacy static assets (jQuery 1.x, Globalize, gadget samples, diff_match_patch): either port or retire; document decisions and delete dead code/CSS stubs.
- [ ] Complete modernization phases: Phase 4 frontend refactors (drop jQuery usage, adopt modern UI patterns/CSS modules or Tailwind) and Phase 5 testing/CI hardening (Jest/Vitest + Playwright/Cypress + perf budgets).
- [ ] Ensure Docker dev stack (CouchDB/Redis/RabbitMQ/Sphinx/MinIO) remains reproducible; add health checks and feature-flag wiring for editor features; document any compose/env changes.

### Inline blip menu, editor parity, and navigation polish
- [x] Validate inline toolbar parity in-browser: collapse state, overflow gear actions (copy/paste reply/cursor, send, playback, delete, link copy), attachment/image upload flow, gadget nodes, color picker, shortcuts; add Playwright smoke run to complement Vitest.
  - (2025-12-05) Added `docs/EDITOR_TOOLBAR_PARITY.md` section outlining file map + Vitest suites (`client.BlipMenu.test.tsx`, `client.blipClipboardStore.test.ts`) that already exercise the restored toolbar; Playwright smoke remains outstanding. Re-ran `npm test -- --run src/tests/client.BlipMenu.test.tsx src/tests/client.inlineCommentsPopover.test.tsx` to confirm coverage stays green.
  - [x] (2026-01-05) Added `npm run test:toolbar-inline` Playwright smoke (`test-toolbar-inline-smoke.mjs`) that launches Chromium against a local wave, walks the inline toolbar (edit/read surfaces, key formatting buttons, overflow trigger) and asserts inline comments navigation renders so parity gaps surface without manual QA.
  - [x] (2025-12-24) Overflow gear now mirrors Delete + Copy Link actions across edit/read states with disabled/loading parity; updated `client.BlipMenu.test.tsx` exercises the new fallback controls. Playwright smoke remains outstanding.
  - [x] (2025-12-04) Expanded `test-toolbar-inline-smoke.mjs` to open both edit/read overflow menus, assert key actions (Send, Copy/Paste variants, playback, link copy) render, and tap the inline comment filters so parity is validated in-browser rather than only through unit tests.
- [x] Ensure per-blip collapse-default setting syncs between CouchDB and localStorage; add tests for offline/restore and multi-tab coherence.
  - (2025-12-11) Collapse preferences now timestamp entries in `collapsePreferences.ts`, race-guard server hydration inside `RizzomaBlip.tsx`, and emit cross-tab storage events; see `src/tests/client.collapsePreferences.test.ts` for coverage.
- [x] Harden inline comment visibility persistence (server + localStorage storage events) and ensure TipTap + BlipMenu stay in sync during rapid toggles.
  - (2025-12-11) Inline comments visibility helper now stores `{ value, updatedAt }`, diffs storage events, and `RizzomaBlip.tsx` guards fetch/patch requests with change tokens; extended `client.inlineCommentsVisibilityStorage.test.ts` exercises metadata + cross-tab broadcasts.

### Testing and QA coverage
- [ ] Test every functionality that's added or modified and update that md file accordingly (or create one if there isn't one already!)
- [x] Add coverage for Follow-the-Green navigation/unread tracking (wave-level) plus degraded-path toasts for editor actions; re-run full Vitest suite and add browser smoke.
  - (2026-03-05) Added `src/tests/client.RightToolsPanel.followGreen.test.tsx` and `src/tests/client.useWaveUnread.test.tsx` to cover the modern Follow-the-Green CTA (`RightToolsPanel`/`FollowTheGreen`) and the `useWaveUnread` hook (initial load, optimistic mark-read, socket `deleted` events, and large-wave stress). `test-follow-green-smoke.mjs` now exercises the multi-user browser flow, and the CTA surfaces inline status/toasts when no unread blips exist or mark-read fails.
  - (2026-03-12) Vitest now exercises mark-read failures (inline status + toast + refresh), the Playwright smoke seeds multiple unread blips + a forced mark-read error before clearing counts on desktop/mobile viewports, and the new `browser-smokes` GitHub job runs both Playwright suites, captures `snapshots/toolbar-inline/` + `snapshots/follow-the-green/`, and uploads artifacts whenever the smokes regress.
  - (2026-03-12) `browser-smokes` now runs even when the build job fails, so snapshots/artifacts are always uploaded for triage; pull them locally via `npm run snapshots:pull` if you need the latest screenshots without rerunning Playwright.
- [x] Gate CI on `npm run test:toolbar-inline` and the Follow-the-Green suite once unread/presence persistence lands so toolbar/unread regressions fail fast.
- [x] Expand automated regression for BlipMenu parity items and failure-path toasts; add cross-browser (Chromium/Firefox/WebKit) smoke runs.
  - (2025-12-04) `client.BlipMenu.test.tsx` now asserts inline comment error banners render in edit mode and that read-only commenting disables the edit overflow paste actions, covering the failure-path toasts surfaced by the inline toolbar; the existing `npm run test:toolbar-inline` smoke already iterates Chromium/Firefox/WebKit.
- [x] Manual testing checklist (MANUAL_TEST_CHECKLIST.md): rerun with restored toolbar/popovers, including keyboard shortcuts (j/k), editor search, performance responsiveness, mobile layout.
  - (2025-12-04) Checklist now contains a dedicated inline toolbar walkthrough (read/edit states, overflow, degraded banners) plus inline comment navigation/shortcut steps so manual runs cover the restored surfaces without extra notes.
- [ ] Add health checks for `/api/health`, inline comments endpoints, and upload endpoints; wire to CI smoke where feasible.
  - (2026-03-05) Added `/api/health` router (`src/server/routes/health.ts`) with `src/tests/server.health.test.ts`, basic inline comments health tests in `src/tests/routes.comments.inlineHealth.test.ts` (feature-flag on/off and empty view handling), and upload edgecase coverage in `src/tests/routes.uploads.edgecases.test.ts` (auth required, missing file error, and successful upload metadata). CI wiring remains outstanding.
  - (2026-03-12) Added the `browser-smokes` GitHub Actions job (`.github/workflows/ci.yml`) to run `npm run test:toolbar-inline` + `npm run test:follow-green`, capture `snapshots/<feature>/`, and upload logs/artifacts whenever the Playwright suites regress. Health endpoint checks still need to be threaded into CI.
- [x] Performance tests: large document load, realtime under concurrency, mobile responsiveness; capture metrics/budgets.
  - (2026-03-12) Added `perf-harness.mjs` (`npm run perf:harness`) to seed a 5k-blip wave via the API, drive Playwright to capture time-to-first-render, and store metrics/screenshots under `snapshots/perf/` so we can start tracking large-wave regressions; wiring it into scheduled runs and broader perf sweeps remains.
  - (2025-12-09) Latest local runs: `npm run lint:branch-context` (pass); `npm run test:toolbar-inline` + `npm run test:follow-green` (desktop+mobile) pass with FEAT_ALL=1 after socket host fix; `npm run test:health` passes; `npm test -- --run src/tests/client.getUserMediaAdapter.test.ts` passes; perf harness 200-blip PASS and 1000-blip FAIL (TTF/render count) with budgets enforced via `scripts/perf-budget.mjs`.

### Documentation and knowledge base
- [x] Audit and correct overstatements in `RIZZOMA_FEATURES_STATUS.md` (tracks A–D marked “implemented” but lack unread/perms/upload validation); align with actual coverage/tests.
  - (2026-03-05) Updated summary, Track C, unread/presence, and "Still pending" sections so Follow-the-Green, perf/resilience, CI/health checks, and backup automation are called out as remaining work, and clarified that `useWaveUnread` + `RightToolsPanel` are the canonical Follow-the-Green surfaces while `GreenNavigation`/`useChangeTracking` act as a test harness.
- [ ] Keep `docs/EDITOR*.md`, `docs/EDITOR_TOOLBAR_PARITY.md`, `README_MODERNIZATION.md`, and onboarding/restart guides current with any API or flag changes; add notes when features remain behind flags or need manual setup.
- [x] Mirror “Next up” items from `README_MODERNIZATION.md`: add Playwright smoke for inline toolbar overflow/gear parity and expand unread navigation/Follow-the-Green regression coverage while documenting degraded-state banners.
  - [x] (2025-12-04) `npm run test:toolbar-inline` now iterates Chromium, Firefox, and WebKit while exercising the inline toolbar overflow/gear actions plus inline comment navigation, so parity gaps surface across browsers without manual QA.
  - [x] (2026-01-07) Added `src/tests/client.followGreenNavigation.test.tsx` to cover `useChangeTracking` + `GreenNavigation` highlight flows and documented the inline comment degraded-state banners across `docs/EDITOR_TOOLBAR_PARITY.md` and `INLINE_COMMENTS_VS_REPLIES.md` so toolbar/popup cues stay synchronized.
- [ ] Refresh `TESTING_STATUS.md` with the next real run (typecheck/tests/build) and note outstanding UI/browser smoke gaps.
  - (2026-03-05) Partially refreshed to clarify Follow-the-Green coverage, FEAT_ALL status, and remaining gaps for large-wave/perf paths; a new end-to-end run is still pending.
- [ ] Add doc notes for backup workflow refinements and any CI additions.

### Operations, automation, and backups
- [ ] Implement Google Drive bundle automation in `scripts/deploy-updates.sh`; schedule post-merge bundle + copy commands and document cadence.
- [ ] Maintain bundle + GDrive backup workflow; verify bundle after each merge.
- [ ] Ensure CI runs typecheck/tests/build and Docker image build; add alerts for failures.

### Miscellaneous code cleanups
- [ ] Investigate and relax restrictions noted in `src/share/utils/string.coffee`.
- [ ] Refactor `scrollableTarget` dependency in `src/share/utils/dom.coffee` (two TODOs).
- [ ] Consolidate icon assets and remove unused legacy CSS/JS stubs across `src/static`.
