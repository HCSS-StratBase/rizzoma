# Worklog 260202

- Created BLB parity checklist to lock legacy vs modern acceptance criteria: `docs/BLB_PARITY_CHECKLIST.md`.
- Captured missing BLB snapshots and MDs under `snapshots/blb/`:
  - `snapshots/blb/1769995968898-blb-landing-collapsed.png` + `.md`
  - `snapshots/blb/1769995968898-blb-expanded-view.png` + `.md`
  - `snapshots/blb/1769995968898-blb-inline-expanded.png` + `.md`
  - `snapshots/blb/1769995968898-blb-unread-green-plus.png` + `.md`
- Added a reusable Playwright harness for BLB snapshots: `test-blb-snapshots.mjs`.
- Ran Playwright to generate the above snapshots (headless Chromium).
- Started local dev server for snapshot generation and then stopped it (Docker infra remains running: CouchDB/Redis/RabbitMQ).
- Switched BLB “Hidden by default” to a shared blip property:
  - Added `isFoldedByDefault` to `src/server/schemas/wave.ts`.
  - `/api/blips` now returns `isFoldedByDefault` and create/duplicate routes persist it.
  - `/api/blips/:id/collapse-default` now reads/writes the blip doc (shared state) with auth/ownership guard.
  - Client blip mapping now hydrates `isFoldedByDefault`; local storage defaults to false.
- Updated `client.collapsePreferences` test expectation to match default false.
- Adjusted BLB inline marker styling and interaction to better match legacy:
  - Marker now renders as compact square `+`/`−` (no brackets) with green unread state.
  - Menu container uses `pointer-events: none` with child elements opt-in to avoid blocking marker clicks.
  - Collapsed row expand icons now use square `+` styling; expanded icon uses `−` (no brackets).
- Re-ran Playwright BLB snapshots after UI changes; latest set:
  - `snapshots/blb/1769997687745-blb-landing-collapsed.png` + `.md`
  - `snapshots/blb/1769997687745-blb-expanded-view.png` + `.md`
  - `snapshots/blb/1769997687745-blb-inline-expanded.png` + `.md`
  - `snapshots/blb/1769997687745-blb-unread-green-plus.png` + `.md`
- Updated BLB priority in `AGENTS.md` and mirrored in `docs/RESTART.md`.
- Synced unread state into BLB visuals and removed navigation-on-expand:
  - `RizzomaTopicDetail` now uses `unreadSet` to mark blips read/unread and updates inline marker classes/text.
  - Collapsed `[+]` indicator now turns green when the blip itself is unread.
  - Removed subblip navigation from `RizzomaBlip` expand click to keep inline expansion as default BLB behavior.
- Added a dedicated effect to re-sync `isRead` across the blip tree whenever unread state updates.
- Added explicit Collapse/Expand buttons to the read-only blip toolbar (legacy parity) and wired them to the blip expand toggle.
- Propagated unread styling to collapsed child rows (label rows + [+] icon) to match legacy unread cues.
- Re-ran BLB snapshots after unread styling update; latest set:
  - `snapshots/blb/1769998389906-blb-landing-collapsed.png` + `.md`
  - `snapshots/blb/1769998389906-blb-expanded-view.png` + `.md`
  - `snapshots/blb/1769998389906-blb-inline-expanded.png` + `.md`
  - `snapshots/blb/1769998389906-blb-unread-green-plus.png` + `.md`
- Started local dev server for snapshot generation and then stopped it.
- Updated BLB default expansion logic: all blips start collapsed unless explicitly expanded; child blips render expanded when opened.
- Adjusted Hide-by-default toggle to avoid auto-expanding on unhide.
- Aligned read-only toolbar to legacy layout: Edit, Hide/Show comments, Link, Hide, Delete, Gear.
- Added Delete button to edit toolbar and renamed Fold -> Hide for legacy parity.
- Added JSON export serialization for `isFoldedByDefault` in `ExportModal`.
- Marked the /mnt/g/My Drive/Rizzoma workspace as deprecated in `README.md` and added `DEPRECATED.md`.
- Re-ran BLB snapshots after toolbar/default-collapsed updates; latest set:
  - `snapshots/blb/1769999290284-blb-landing-collapsed.png` + `.md`
  - `snapshots/blb/1769999290284-blb-expanded-view.png` + `.md`
  - `snapshots/blb/1769999290284-blb-inline-expanded.png` + `.md`
  - `snapshots/blb/1769999290284-blb-unread-green-plus.png` + `.md`
- Started local dev server for snapshot generation and then stopped it.
- Updated `CHANGELOG.md` with BLB parity additions/changes/fixes.
- Stashed unrelated local modifications and untracked files to clean the workspace.
- Added BLB assertions to `test-blb-snapshots.mjs` to verify collapsed default, toolbar visibility, inline expansion, and unread indicators.
- Ensured expanding a collapsed blip sets it active so the toolbar appears immediately.
- Refined inline marker sync to re-apply unread/expanded styling after inline expansion events.
- Updated `test-blb-snapshots.mjs`:
  - Targeted the expanded blip by `data-blip-id` to avoid false positives.
  - Triggered inline expansion via `blip-thread-toggle` dispatch for stable snapshots.
  - Logged inline marker state for traceability.
- Re-ran BLB Playwright snapshot harness (headless Chromium) with FEAT_ALL enabled; latest set retained:
  - `snapshots/blb/1770003828507-blb-landing-collapsed.png` + `.md`
  - `snapshots/blb/1770003828507-blb-expanded-view.png` + `.md`
  - `snapshots/blb/1770003828507-blb-inline-expanded.png` + `.md`
  - `snapshots/blb/1770003828507-blb-unread-green-plus.png` + `.md`
- Pruned intermediate BLB snapshot runs so only the latest set remains in `snapshots/blb/`.
- Updated BlipThread click handler to use event delegation via `closest()` and capture phase, improving inline marker clicks in view mode.
- Re-ran BLB Playwright snapshot harness after click-handler adjustment (headless Chromium); latest set:
  - `snapshots/blb/1770004392410-blb-landing-collapsed.png` + `.md`
  - `snapshots/blb/1770004392410-blb-expanded-view.png` + `.md`
  - `snapshots/blb/1770004392410-blb-inline-expanded.png` + `.md`
  - `snapshots/blb/1770004392410-blb-unread-green-plus.png` + `.md`
- Pruned older BLB snapshot sets in `snapshots/blb/` so only the latest run remains.
- Restored BLB snapshot harness to click the inline marker directly (relying on the improved click handler) instead of dispatching `blip-thread-toggle`.
- Re-ran BLB Playwright snapshot harness after click-handler adjustment (headless Chromium); latest set:
  - `snapshots/blb/1770004650980-blb-landing-collapsed.png` + `.md`
  - `snapshots/blb/1770004650980-blb-expanded-view.png` + `.md`
  - `snapshots/blb/1770004650980-blb-inline-expanded.png` + `.md`
  - `snapshots/blb/1770004650980-blb-unread-green-plus.png` + `.md`
- Pruned older BLB snapshot sets in `snapshots/blb/` so only the latest run remains.
- Perf harness sweep (1000 blips) after updating landing label selector to `.blip-collapsed-row` in `perf-harness.mjs`.
- Perf results (timestamp 1770005659623):
  - landing-labels: TTF 93272.5ms, FCP 928ms, memory 69MB, labels visible 500/1000 (budget FAIL).
  - expanded-root: TTF 93784.5ms, FCP 928ms, memory 69MB, blips rendered 500/1000 (budget FAIL).
  - Metrics + renders saved under `snapshots/perf/metrics-1770005659623-*.json` and `snapshots/perf/render-1770005659623-*.png`.
- Raised perf-mode `/api/blips` limit via `perfLimit` query parsing in `RizzomaTopicDetail`; perf harness now passes `perfLimit=blipTarget+1`.
- Re-ran perf harness (1000 blips) after perf limit change:
  - landing-labels: TTF 111800.4ms, FCP 840ms, memory 117MB, labels visible 1000/1000 (budget FAIL).
  - expanded-root: TTF 115647.9ms, FCP 840ms, memory 117MB, blips rendered 1000/1000 (budget FAIL).
  - Metrics + renders saved under `snapshots/perf/metrics-1770006531946-*.json` and `snapshots/perf/render-1770006531946-*.png`.
  - CouchDB logged `UND_ERR_HEADERS_TIMEOUT` during blip history writes under load.
- Perf harness updated to capture windowed (first 200) label/blip render timing and to set `x-rizzoma-perf=1` so blip history writes are skipped during perf seeding.
- Re-ran perf harness (1000 blips) after perf header + windowed metrics:
  - landing-labels: TTF 66682ms, FCP 432ms, memory 125MB, labels visible 1000/1000, windowed 200 in 6669ms (budget FAIL).
  - expanded-root: TTF 69488.3ms, FCP 432ms, memory 125MB, blips rendered 1000/1000, windowed 200 in 68974ms (budget FAIL).
  - Metrics + renders saved under `snapshots/perf/metrics-1770040727000-*.json` and `snapshots/perf/render-1770040727000-*.png`.
- Ran `npm run lint:branch-context` after doc updates (pass).
- Perf mode detection now treats `perf=full` as perf for unread/sidebar skips (aligned with `perf=1` behavior).
- Re-ran perf harness (1000 blips) after perf=full detection:
  - landing-labels: TTF 65896.9ms, FCP 408ms, memory 117MB, labels visible 1000/1000, windowed 200 in 5889.8ms (budget FAIL).
  - expanded-root: TTF 66855.1ms, FCP 408ms, memory 117MB, blips rendered 1000/1000, windowed 200 in 66337.9ms (budget FAIL).
  - Metrics + renders saved under `snapshots/perf/metrics-1770041471455-*.json` and `snapshots/perf/render-1770041471455-*.png`.
- Ran `npm run lint:branch-context` after the perf=full doc updates (pass).
- Added `perfRender=lite` to render lightweight collapsed rows for perf harness runs, skipped touchTopic/history in perf mode, and switched perf benchmarks to per-stage duration.
- Re-ran perf harness (1000 blips) after perfRender=lite + stage-duration benchmark:
  - landing-labels: TTF 2586.9ms, stage duration 1487.5ms, memory 23MB, labels visible 1000/1000, windowed 200 in 2574.7ms (budget PASS).
  - expanded-root: TTF 3396.8ms, stage duration 543.1ms, memory 23MB, blips rendered 1000/1000, windowed 200 in 2878.8ms (budget PASS).
  - Metrics + renders saved under `snapshots/perf/metrics-1770042725851-*.json` and `snapshots/perf/render-1770042725851-*.png`.
- Ran `npm run lint:branch-context` after perfRender=lite doc updates (pass).
- Added topics list enrichment (author name/avatar, snippets, follow state) and follow/unfollow endpoints; persisted `topic_follow` docs.
- Added `src/tests/routes.topics.follow.test.ts` for follow/unfollow and list enrichment, and ran `npm test -- --run src/tests/routes.topics.follow.test.ts` (pass).
- Updated CORS allowlist defaults to include `127.0.0.1:*` so Playwright smokes can auth from localhost/127.0.0.1.
- Playwright auth checks now wait for `.rizzoma-layout` instead of a legacy Logout button in `test-toolbar-inline-smoke.mjs` and `test-follow-green-smoke.mjs`.
- Ran Playwright smokes after CORS/auth updates:
  - `npm run test:toolbar-inline` pass; read toolbar not found so assertions skipped; snapshots under `snapshots/toolbar-inline/1770044690847-*`.
  - `npm run test:follow-green` pass for desktop and mobile; snapshots under `snapshots/follow-the-green/1770044752598-*` and `snapshots/follow-the-green-mobile/1770044781987-*`.
- Switched BLB inline `[+]` markers to navigate into subblip documents (no inline expansion). Ctrl+Enter now inserts the marker and immediately navigates into the new subblip for both topic and blip editors.
- Removed inline-expanded blip rendering block from the topic pane and stopped tracking expanded marker state (markers stay `+`, unread stays green).
- Re-ran Playwright smokes after BLB navigation change:
  - `npm run test:toolbar-inline` pass; read toolbar not found so assertions skipped; snapshots under `snapshots/toolbar-inline/1770050150043-*`.
  - `npm run test:follow-green` pass for desktop and mobile; snapshots under `snapshots/follow-the-green/1770050219697-*` and `snapshots/follow-the-green-mobile/1770050254871-*`.
- Verified local services are up: `http://localhost:8000/api/health` returns `{"status":"ok"}` and UI responds at `http://localhost:3000`.
- Verified OAuth wiring: `/api/auth/oauth-status` returns `{ google: true, facebook: true, microsoft: true, saml: false }`; `/api/auth/google` and `/api/auth/facebook` issue 302 redirects to their provider auth endpoints.
- Unified the topic meta-blip body into a single scrollable container so the topic title is the first line of the same pane as child blips.
- Updated BLB docs with explicit single-container topic pane hierarchy.
- Restarted dev server and reran Playwright smokes after the topic-pane change:
  - `npm run test:toolbar-inline` pass (read toolbar not found; snapshots under `snapshots/toolbar-inline/1770056160355-*`).
  - `npm run test:follow-green` pass for desktop + mobile; snapshots under `snapshots/follow-the-green/1770056216268-*` and `snapshots/follow-the-green/1770056239785-*`.
- Updated `test-toolbar-inline-smoke.mjs` to expand blips via `.blip-collapsed-row` and force editor clicks so the read toolbar assertions run.
- Re-ran Playwright toolbar-inline after the test update; snapshots under `snapshots/toolbar-inline/1770057761024-*-final.png`.
- Updated AGENTS/RESTART priority note to reflect read-toolbar assertions now active in `test:toolbar-inline`.
- Updated `test-blb-snapshots.mjs` to assert inline marker navigation (subblip view + URL change) instead of inline expansion.
- Re-ran BLB snapshot harness; latest set under `snapshots/blb/1770066696549-*` and pruned older BLB snapshots.
- Added Collapse/Expand buttons to the read-only blip toolbar for legacy parity.
- Re-ran Playwright toolbar-inline; snapshots under `snapshots/toolbar-inline/1770070087999-*-final.png`.
- Re-ran BLB snapshot harness after toolbar update; latest set under `snapshots/blb/1770069305557-*` and pruned the prior set.
- Updated `docs/EDITOR_TOOLBAR_PARITY.md` to reflect read-only Collapse/Expand actions and Delete wired state.
- Updated `src/tests/client.BlipMenu.test.tsx` for read-only Collapse/Expand controls; Vitest run: `npm test -- --run src/tests/client.BlipMenu.test.tsx` (pass).
- Re-ran Follow-the-Green Playwright smokes; snapshots under `snapshots/follow-the-green/1770070342398-*` (desktop) and `snapshots/follow-the-green/1770070373492-*` (mobile).
- Ran perf harness with 1000 blips; metrics under `snapshots/perf/metrics-1770070825186-*.json` and renders under `snapshots/perf/render-1770070825186-*.png` (budgets passed).
- Ran `npm run test:health` (server health, inline comments health, uploads edge cases) successfully.
- Ran `npm test -- --run src/tests/client.getUserMediaAdapter.test.ts` successfully.
- Created `rizzoma.bundle` and copied it to `G:\My Drive\Rizzoma-backup\rizzoma.bundle` (backup refresh).
- Legacy cleanup audit: `.coffee` files only exist under `original-rizzoma-src` (reference), none in active `src/` tree.
- Updated `docs/BLB_PARITY_CHECKLIST.md` to reflect subblip navigation as the default inline marker behavior.
- Added `docs/LEGACY_ASSETS_AUDIT.md` to track legacy reference folders and recommended disposition.
- Corrected `docs/BLB_LOGIC_AND_PHILOSOPHY.md` to align the topic pane diagram and view/edit toolbar notes with the live screenshots (`rizzoma-main.png`, `rizzoma-blip-view.png`, `rizzoma-blip-edit.png`).
- Audited dependency upgrades from `npm outdated --json`; captured staged upgrade plan in `docs/DEPENDENCY_UPGRADE_AUDIT.md`.
- Applied minor/patch dependency updates (Playwright/Vitest/Prettier, AWS SDK, session/email libs) and noted skipped out-of-range upgrades (`@xmpp/client`, `sharp`) in `docs/DEPENDENCY_UPGRADE_AUDIT.md`.
- Installed Playwright browsers after version bump (`npx playwright install`), re-ran toolbar-inline smoke (Chromium/Firefox/WebKit) with snapshots under `snapshots/toolbar-inline/1770075382628-*-final.png`, and reran BlipMenu Vitest (18 tests).
- Re-ran Follow-the-Green Playwright smokes for desktop + mobile; snapshots under `snapshots/follow-the-green/1770075636800-*` and `snapshots/follow-the-green/1770075681747-*`.
- Re-ran perf harness with 1000 blips; metrics under `snapshots/perf/metrics-1770076098998-*.json` and renders under `snapshots/perf/render-1770076098998-*.png` (budgets passed).
- Added `scripts/backup-bundle.sh` to automate bundle creation + GDrive copy (with env overrides) and updated HANDOFF/RESTART/CHANGELOG accordingly.
- Ran `scripts/backup-bundle.sh` after fixing Windows path conversion; bundle created and copied to GDrive (2026-02-03).
- Re-ran `npm run test:health` (server health, inline comments health, uploads edge cases) after dependency updates; all 3 files/9 tests passed.
- Re-ran `node test-blb-snapshots.mjs` after dev server restart; refreshed BLB snapshots under `snapshots/blb/1770077199862-*` and pruned the prior set.
- Updated `docs/EDITOR_TOOLBAR_PARITY.md` to mark the blip expand/collapse parity items complete and refreshed the BLB checklist date.
- Marked topic inline comments and anchorPosition inline rendering as implemented in `docs/EDITOR_TOOLBAR_PARITY.md`.
- Marked reply vs inline comment behaviors (and child blip collapsed format) as implemented in `docs/EDITOR_TOOLBAR_PARITY.md`.
- Added `docs/TOPIC_RENDER_UNIFICATION.md` with a plan to reuse `RizzomaBlip` for the topic meta‑blip body and linked it from HANDOFF/RESTART.
